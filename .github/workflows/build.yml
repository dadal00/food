name: Docker Build

on:
  push:
    branches:
      - "**"

permissions:
  packages: write
  contents: write

jobs:
  cook:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - name: Configure cache
        uses: Swatinem/rust-cache@v2

      - name: Cook and push
        run: |
          cargo install cargo-chef
          cargo chef prepare --recipe-path recipe.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- recipe.json; then
            echo "No changes in recipe.json"
            exit 0
          fi

          echo "Changes detected â€” committing"
          git add recipe.json
          git commit -m "Update recipe.json"
          git push origin HEAD:${GITHUB_REF_NAME}

  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image tags
        run: |
          set -a
          source .env
          set +a

          REMOTE="ghcr.io/${{ github.repository_owner }}/${RUST_IMAGE}"
          echo "REMOTE=$REMOTE" >> "$GITHUB_ENV"

          SHA="${{ github.sha }}"
          echo "REMOTE_SHA=${SHA:0:7}" >> "$GITHUB_ENV"

          RAW_MSG="${{ github.event.head_commit.message }}"
          SANITIZED_MSG=$(printf '%s' "$RAW_MSG" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9._-')
          echo "REMOTE_MSG=${SANITIZED_MSG:-no-msg}" >> "$GITHUB_ENV"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./backend/Dockerfile
          platforms: "linux/arm64"
          push: ${{ github.ref == 'refs/heads/main' }}
          cache-to: type=gha
          cache-from: type=gha
          tags: ${{ env.REMOTE }},${{ env.REMOTE_SHA }},${{ env.REMOTE_MSG }}
